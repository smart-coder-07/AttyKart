package com.wallet.service;

import java.util.Date;
import java.util.List;
import java.util.Optional;

import org.springframework.stereotype.Service;

import com.wallet.exception.WalletNotFoundException;
import com.wallet.model.Wallet;
import com.wallet.repository.WalletRepository;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class WalletServiceImpl implements WalletService {
    private final WalletRepository walletRepository;

    @Override
    public Wallet addFunds(Wallet transaction) {
        transaction.setTransactionDate(new Date());
        transaction.setTransactionType("CREDIT");
        transaction.setTransactionStatus("SUCCESS");
        return walletRepository.save(transaction);
    }

    @Override
    public Wallet deductFunds(Wallet transaction) {
        // Fetch the user's latest balance
        Optional<Wallet> latestTransaction = walletRepository.findTopByUserIdOrderByTransactionDateDesc(transaction.getUserId());

        double currentBalance = latestTransaction.map(Wallet::getAmount).orElse(0.0);

        if (currentBalance < transaction.getAmount()) {
            transaction.setTransactionStatus("FAILED");
            throw new WalletNotFoundException("Insufficient balance for user: " + transaction.getUserId());
        }

        // Deduct balance
        transaction.setAmount(currentBalance - transaction.getAmount());
        transaction.setTransactionDate(new Date());
        transaction.setTransactionType("DEBIT");
        transaction.setTransactionStatus("SUCCESS");

        return walletRepository.save(transaction);
    }

    @Override
    public List<Wallet> getTransactionsByUserId(String userId) {
        return walletRepository.findByUserId(userId);
    }
}
